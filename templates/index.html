<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Risk Assessment</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body>
    <form id="riskForm" method="POST" action="/" onsubmit="return handleFormSubmit(event)">
        <!-- General -->
        <div class="form-group">
          <h2 class="heading">Credit Information</h2>
          
          <!-- Person Age -->
          <div class="controls">
            <input type="number" id="person_age" class="floatLabel" name="person_age" min="18" max="100" step="1" required>
            <label for="person_age">Age</label>
          </div>
          
          <!-- Person Income -->
          <div class="controls">
            <input type="number" id="person_income" class="floatLabel" name="person_income" step="0.01" placeholder="Enter annual income" required>
            <label for="person_income">Income (₹)</label>
          </div>
      
          <!-- Home Ownership -->
          <div class="controls">
            <i class="fa fa-sort"></i>
            <select id="person_home_ownership" class="floatLabel" name="person_home_ownership" required>
              <option value=""></option>
              <option value="own">Own</option>
              <option value="rent">Rent</option>
              <option value="mortgage">Mortgage</option>
            </select>
            <label for="person_home_ownership">Home Ownership</label>
          </div>
          
          <!-- Loan Amount -->
          <div class="controls">
            <input type="number" id="loan_amnt" class="floatLabel" name="loan_amnt" step="0.01" placeholder="Enter loan amount" required>
            <label for="loan_amnt">Loan Amount (₹)</label>
          </div>
      
          <!-- Loan Interest Rate -->
          <div class="controls">
            <input type="number" id="loan_int_rate" class="floatLabel" name="loan_int_rate" step="0.01" placeholder="Enter loan interest rate" required>
            <label for="loan_int_rate">Loan Interest Rate (%)</label>
          </div>
      
          <!-- Loan Percent Income -->
          <div class="controls">
            <input type="number" id="loan_percent_income" class="floatLabel" name="loan_percent_income" step="0.01" placeholder="Loan percent of income" required>
            <label for="loan_percent_income">Loan Percent of Income (%)</label>
          </div>
      
          <!-- Person Default on File -->
          <div class="controls">
            <i class="fa fa-sort"></i>
            <select id="cb_person_default_on_file" class="floatLabel" name="cb_person_default_on_file" required>
              <option value=""></option>
              <option value="yes">Yes</option>
              <option value="no">No</option>
            </select>
            <label for="cb_person_default_on_file">Default on File</label>
          </div>
      
          <button type="submit" value="Submit" class="col-1-4">Submit</button>
        </div>
    </form>

    <!-- Display user's location and city -->
    <div id="location">
        <h3>Your Location:</h3>
        <p id="lat"></p>
        <p id="long"></p>
        <h3>Your City:</h3>
        <p id="city"></p>
    </div>
    
    <script>
        function handleFormSubmit(event) {
            event.preventDefault(); // Prevent the form from submitting immediately
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(showPosition, showError);
            } else {
                alert("Geolocation is not supported by this browser.");
            }
        }

        function showPosition(position) {
            const lat = position.coords.latitude;
            const long = position.coords.longitude;

            // Call reverse geocoding API to get the city name
            getCity(lat, long).then(city => {
                // Update the form with latitude, longitude, and city
                const form = document.getElementById("riskForm");

                // Add hidden inputs for latitude, longitude, and city
                const latInput = document.createElement("input");
                latInput.type = "hidden";
                latInput.name = "latitude";
                latInput.value = lat;
                form.appendChild(latInput);

                const longInput = document.createElement("input");
                longInput.type = "hidden";
                longInput.name = "longitude";
                longInput.value = long;
                form.appendChild(longInput);

                const cityInput = document.createElement("input");
                cityInput.type = "hidden";
                cityInput.name = "city";
                cityInput.value = city;
                form.appendChild(cityInput);

                // Submit the form after location is obtained
                form.submit();
            });
        }

        function getCity(lat, long) {
            const url = `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${long}`;
            return fetch(url)
                .then(response => response.json())
                .then(data => {
                    const city = data.address.city || data.address.town || data.address.village || 'Unknown';
                    document.getElementById("city").innerHTML = "City: " + city;
                    return city;
                })
                .catch(error => {
                    console.error('Error fetching city:', error);
                    return 'Unknown';
                });
        }

        function showError(error) {
            switch(error.code) {
                case error.PERMISSION_DENIED:
                    alert("User denied the request for Geolocation.");
                    break;
                case error.POSITION_UNAVAILABLE:
                    alert("Location information is unavailable.");
                    break;
                case error.TIMEOUT:
                    alert("The request to get user location timed out.");
                    break;
                case error.UNKNOWN_ERROR:
                    alert("An unknown error occurred.");
                    break;
            }
        }
    </script>
    <script src="{{ url_for('static', filename='js/scripts.js') }}"></script>
</body>
</html>